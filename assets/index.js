var Ji=Object.defineProperty;var ts=(t,e,i)=>e in t?Ji(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var y=(t,e,i)=>ts(t,typeof e!="symbol"?e+"":e,i);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function i(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=i(n);fetch(n.href,a)}})();const g=document.querySelector("canvas"),o=g.getContext("2d",{willReadFrequently:!0});let ct=null,jt=null;const es=(t,e,i)=>{if(ct=document.createElement("canvas"),ct.width=t,ct.height=e,jt=ct.getContext("2d"),jt){jt.fillStyle=`rgba(0, 0, 0, ${1-i})`;for(let s=0;s<e;s+=2)jt.fillRect(0,s,t,1)}},lt=(t=!0)=>{const e=g.width,i=g.height,s=o.getImageData(0,0,e,i),n=s.data,a=t?.7:.8,r=t?10:0,l=t?new Float32Array(e*i):null;if(t&&l)for(let c=0;c<l.length;c++)l[c]=(Math.random()-.5)*r;if(t&&l)for(let c=0;c<i;c++){const f=c*e;for(let w=0;w<e;w++){const p=(f+w)*4,d=l[f+w];n[p]+=d,n[p+1]+=d,n[p+2]+=d}}o.putImageData(s,0,0),(!ct||ct.width!==e||ct.height!==i)&&es(e,i,a),jt&&ct&&(o.globalAlpha=a,o.drawImage(ct,0,0),o.globalAlpha=1)};let Qt;const is=()=>{const t=g.width,e=g.height;Qt=o.createRadialGradient(t/2,e/2,0,t/2,e/2,t/2),Qt.addColorStop(0,"rgba(255, 255, 255, 0.3)"),Qt.addColorStop(1,"rgba(0, 0, 0, 0.5)")},It=()=>{Qt||is(),o.fillStyle=Qt,o.fillRect(0,0,g.width,g.height)},Ei=()=>{const t=o.getImageData(0,0,g.width,g.height),e=t.data;for(let i=0;i<e.length;i+=4){const s=e[i],n=e[i+1],a=e[i+2],r=s*.3+n*.59+a*.11;e[i]=e[i+1]=e[i+2]=r*.7}o.putImageData(t,0,0)},ss=()=>{const t=document.createElement("canvas");t.width=4,t.height=4;const e=t.getContext("2d");if(!e)return;function i(n,a,r,l,c){e&&(e.strokeStyle=c,e.beginPath(),e.moveTo(n,a),e.lineTo(r,l),e.stroke())}const s="#00000010";e.fillStyle=s,e.fillRect(0,0,t.width,t.height);for(let n=0;n<=t.width;n+=4)i(n,0,n,t.height,s),i(0,n,t.width,n,s);return e.createPattern(t,"repeat")},ns=()=>{const t=document.createElement("canvas");t.width=64,t.height=64;const e=t.getContext("2d");if(!e)return;const i=e.getImageData(0,0,t.width,t.height),s=i.data,n=4;for(let a=0;a<t.height;a+=n)for(let r=0;r<t.width;r+=n){const l=Math.random()*64,c=Math.floor(Math.random()*24);for(let f=0;f<n;f++)for(let w=0;w<n;w++){const p=((a+f)*t.width+(r+w))*4;s[p]=Math.min(255,Math.max(0,s[p]+l)),s[p+1]=Math.min(255,Math.max(0,s[p+1]+l)),s[p+2]=Math.min(255,Math.max(0,s[p+2]+l)),s[p+3]=c}}return e.putImageData(i,0,0),e.createPattern(t,"repeat")};var _=(t=>(t[t.Tiny=16]="Tiny",t[t.Xs=20]="Xs",t[t.Small=24]="Small",t[t.Normal=32]="Normal",t[t.Large=48]="Large",t[t.Xl=64]="Xl",t[t.Huge=80]="Huge",t))(_||{});const Ke=t=>{const e=g.width/1e3;return Math.floor(t*e)},H=(t,e,i,s=1,n=0,a=!0,r=0,l)=>{o.save();const c=Ke(e),f=Ke(16);o.globalAlpha=s>0?s:0,o.fillStyle="white",o.font=c+"px "+i;const w=o.measureText(l??t).width,p=n*f,d=r*f;o.fillText(t,(g.width-w)/2+d,(a?g.height/2:0)+p),o.restore()},Mi=()=>({ArrowLeft:!1,ArrowRight:!1,ArrowUp:!1,ArrowDown:!1,KeyW:!1,KeyA:!1,KeyS:!1,KeyD:!1});let Gt=Mi();const as=t=>{t.code in Gt&&(Gt[t.code]=!0)},os=t=>{t.code in Gt&&(Gt[t.code]=!1)},rs=()=>{window.addEventListener("keydown",as),window.addEventListener("keyup",os),window.addEventListener("blur",()=>{Gt=Mi()})},qe=t=>new Promise(e=>setTimeout(e,t)),ls=()=>Gt;function hs(t){return{x:t.x+t.width/2,y:t.y+t.height/2}}function fe(t,e){const i=e.x<=t.x+t.width&&t.x<=e.x+e.width,s=e.y<=t.y+t.height&&t.y<=e.y+e.height;return i&&s}function cs(t,e){return t.x<=e.x&&e.x<t.x+t.width&&t.y<=e.y&&e.y<t.y+t.height}function fs(t,e){const i=t.x<=e.x&&e.x+e.width<=t.x+t.width,s=t.y<=e.y&&e.y+e.height<=t.y+t.height;return i&&s}function Ie(t){return-(Math.cos(Math.PI*t)-1)/2}function at(t){return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2}function ke(t){return t*t}function ds(t){return t===0?0:t===1?1:t<.5?Math.pow(2,20*t-10)/2:(2-Math.pow(2,-20*t+10))/2}class gs{constructor(e,i){y(this,"x",0);y(this,"y",0);y(this,"zoom",1);y(this,"visibleAreaHeight");y(this,"yAdjust",0);y(this,"target",null);y(this,"transition",null);this.level=e,this.view=i}getViewArea(){const e=this.view.width/this.zoom,i=this.view.height/this.zoom;return{x:this.x-e/2,y:this.y-i/2,width:e,height:i}}follow(e){this.target=e}setTransition(e){const i=this.view.height/this.zoom;this.transition={...e,endY:e.endY+i*this.yAdjust},this.target=null}update(e){if(this.visibleAreaHeight!=null&&(this.zoom=this.view.height/this.visibleAreaHeight),this.transition!=null){const{startY:i,endY:s,startTime:n,duration:a}=this.transition;if(e<n+a){const l=(e-this.transition.startTime)/this.transition.duration;this.y=i+ds(l)*(s-i)}else this.transition=null}else this.target&&this.followFrame(this.target)}followFrame(e){const i=this.view.width/this.zoom,s=this.view.height/this.zoom;if(i<this.level.width){let n=e.x+e.width;n-i/2<this.level.x?n=this.level.x+i/2:n+i/2>this.level.x+this.level.width&&(n=this.level.x+this.level.width-i/2),this.x=n}else this.x=0;this.y=e.y+s*this.yAdjust}}const J={x:0,y:0};function he(t){return t.x===0&&t.y===0}function us(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}function ys(t,e){return Math.abs(t.x-e.x)}function ms(t,e){return Math.abs(t.y-e.y)}function Xt(t){return Math.sqrt(t.x*t.x+t.y*t.y)}function ft(t,e){return{x:t.x+e.x,y:t.y+e.y}}function Pi(t,e){return{x:t.x-e.x,y:t.y-e.y}}function rt(t,e){return{x:t.x*e,y:t.y*e}}function ps(t,e){return{x:t.x/e,y:t.y/e}}function dt(t){return ps(t,Xt(t))}function Jt(t,e){return t.x*e.x+t.y*e.y}const Dt=.5,ws=.01,bs=5e-4,je=6e-4,vs=3;function Ss(t,e,i){if(he(e)){const m=Xt(t.velocity),S=je*i,I=m>S?m-S:0;return I>0?rt(dt(t.velocity),I):J}const s=Jt(t.velocity,e),n={x:-e.y,y:e.x},a=Jt(t.velocity,n);let r=bs*i;s>ws*i&&(r=0);const l=je*i,c=Math.abs(a)>l?-l:0,f=Math.sign(a)*c,w=rt(e,r),p=rt(n,f);return ft(t.velocity,ft(w,p))}function Is(t,e){const i=t.width/2,s=t.height/2,n=e.width/2,a=e.height/3.5,r={x:t.x+t.width/2,y:t.y+t.height/2},l=ft(r,t.velocity),c={x:e.x+e.width/2,y:e.y+e.height/2};if(ys(l,c)<i+n&&ms(l,c)<s+a){const f=dt(Pi(c,r)),w=Jt(t.velocity,f),p=rt(f,-Math.abs(w)*vs);let d=ft(t.velocity,p);return Xt(d)>Dt&&(d=rt(dt(d),Dt)),t.velocity=d,!0}return!1}function ks(t,e){const i=t.width*.4,s=e.width*.4,n={x:t.x+t.width/2,y:t.y+t.height/2},a={x:e.x+e.width/2,y:e.y+e.height/2},r=ft(n,t.velocity),l=ft(a,e.velocity);if(us(r,l)<i+s){const c=dt(Pi(a,n)),f=rt(c,-1),w=Jt(t.velocity,c),p=Jt(e.velocity,f),d=rt(c,Math.abs(w)),m=rt(f,Math.abs(p));let S=ft(t.velocity,m);Xt(S)>Dt&&(S=rt(dt(S),Dt)),t.velocity=S;let I=ft(e.velocity,d);return Xt(I)>Dt&&(I=rt(dt(I),Dt)),e.velocity=I,!0}return!1}const wt=(t=1)=>Math.random()*t,xs=(t,e)=>Math.random()*(e-t)+t,Bt=class Bt{constructor(e){y(this,"x");y(this,"y");y(this,"width",Bt.WIDTH);y(this,"height",Bt.HEIGHT);y(this,"velocity",J);this.x=e.x,this.y=e.y}draw(e,i){o.save(),o.translate(this.x,this.y);const s=o.createLinearGradient(0,0,this.width,this.height);s.addColorStop(0,"rgb(255, 110, 110)"),s.addColorStop(1,"rgb(255, 60, 60)"),o.beginPath(),o.fillStyle="rgba(0, 0, 0, 0.1)",o.ellipse(this.width/2,this.height/1.5,this.width/2,this.height,0,0,2*Math.PI),o.fill(),o.fillStyle=s,o.beginPath(),o.ellipse(this.width/2,this.height/2,this.width/2,this.height/2,0,0,2*Math.PI),o.fill(),o.fillStyle=s,o.fillRect(0,-this.height*2,this.width,this.height*2.5);const n=o.createLinearGradient(0,0,this.width,this.height);n.addColorStop(0,"rgb(255, 140, 140)"),n.addColorStop(1,"rgb(255, 80, 80)"),o.fillStyle=n,o.beginPath(),o.ellipse(this.width/2,-this.height*2,this.width/2,this.height/2,0,0,2*Math.PI),o.fill(),o.strokeStyle="rgb(200, 70, 70)",o.lineWidth=this.width/100,o.stroke(),o.restore()}};y(Bt,"WIDTH",10),y(Bt,"HEIGHT",4);let A=Bt;const b=16,u=10,Ri=b,Nt=9,yt=u*Nt,xe=u*7,Cs=u*5,Qe=u*3,v=-90/2,Ze=yt/2;var h=(t=>(t[t.FullWidth=0]="FullWidth",t[t.Basic=1]="Basic",t[t.BasicSlope=2]="BasicSlope",t[t.BasicSteepSlope=3]="BasicSteepSlope",t[t.Narrow=4]="Narrow",t[t.VeryNarrow=5]="VeryNarrow",t[t.DualPassage=6]="DualPassage",t[t.DualPassageExt=7]="DualPassageExt",t[t.TriplePassage=8]="TriplePassage",t[t.RightPassage=9]="RightPassage",t[t.SlopeEmptySlope=10]="SlopeEmptySlope",t[t.SlopeEmptyPassage=11]="SlopeEmptyPassage",t[t.PassageEmptySlope=12]="PassageEmptySlope",t[t.SlopeObstacleSlope=13]="SlopeObstacleSlope",t[t.FullWidthWithObstaclesOnRight=14]="FullWidthWithObstaclesOnRight",t[t.FullWidthWithObstaclesOnRight2=15]="FullWidthWithObstaclesOnRight2",t[t.FullWidthWithMoreObstacles=16]="FullWidthWithMoreObstacles",t[t.FullWidthWithObstacles=17]="FullWidthWithObstacles",t[t.Chasm=18]="Chasm",t[t.Raft=19]="Raft",t[t.TwoRafts=20]="TwoRafts",t[t.Checkpoint=21]="Checkpoint",t[t.Finish=22]="Finish",t))(h||{}),ht=(t=>(t[t.Normal=0]="Normal",t[t.CheckPoint=1]="CheckPoint",t[t.Finish=2]="Finish",t[t.Raft=3]="Raft",t))(ht||{}),D=(t=>(t[t.Empty=0]="Empty",t[t.Free=1]="Free",t[t.Obstacle=2]="Obstacle",t[t.Raft=3]="Raft",t))(D||{});function Fi(t,e,i){return{type:0,row:t,col:e,x:v+e*u,y:i,width:u,height:b}}function Oe(t){return"yDirection"in t}function de(t){return"force"in t}class As{constructor(e,i,s,n,a){y(this,"row");y(this,"y");y(this,"type");y(this,"surfaces");y(this,"objects");y(this,"width");y(this,"height");y(this,"minX");y(this,"maxX");y(this,"blocks",new Array(Nt));this.row=e,this.y=i,this.type=s,this.surfaces=n,this.objects=a,this.minX=Math.min(...this.surfaces.map(r=>r.x)),this.maxX=Math.max(...this.surfaces.map(r=>r.x+r.width)),this.width=this.maxX-this.minX,this.height=b;for(let r=0;r<Nt;r++)this.blocks[r]={type:this.getBlockType(r),row:e,col:r,x:v+r*u,y:this.y,width:u,height:b}}get color(){switch(this.type){case 1:return"rgb(50, 80, 50)";case 2:return"rgb(0, 200, 0)";case 3:return"rgb(50,60,120)";default:return"rgb(80, 50, 80)"}}getBlock(e){return e<0||Nt<=e?Fi(this.row,e,this.y):this.blocks[e]}isFree(e,i){const s=u*.1,n=v+e*u,a=i??this.y,r={x:n+s,y:a+s,width:u-2*s,height:Ri-2*s};return this.surfaces.some(l=>fs(l,r))&&!this.objects.some(l=>fe(l,r))}getBlockType(e){const i=u*.1,s=v+e*u+i,n=u-2*i;return this.surfaces.some(l=>Oe(l)&&l.x<=s&&s+n<=l.x+l.width)?3:this.objects.some(l=>l.x<=s&&s+n<=l.x+l.width)?2:this.isFree(e)?1:0}}function Es(t,e){const i=t.map((s,n)=>Ms(s,n,e));return Ps(i),i}function Ms(t,e,i){const s=i-b*(e+1),n=s+b/2;let a=0,r=[],l=[];switch(t){case 0:r=[{x:v,y:s,width:yt,height:b}];break;case 1:r=[{x:v+u*1,y:s,width:xe,height:b}];break;case 2:{r=[{force:.3,x:v+u*1,y:s,width:xe,height:b}];break}case 3:{r=[{force:.5,x:v+u*1,y:s,width:xe,height:b}];break}case 4:r=[{x:v+u*2,y:s,width:Cs,height:b}];break;case 5:r=[{x:v+u*3,y:s,width:Qe,height:b}];break;case 6:r=[{x:v+u,y:s,width:u*2,height:b},{x:Ze-u*3,y:s,width:u*2,height:b}];break;case 7:r=[{x:v+u,y:s,width:u*2,height:b},{x:v+u*4,y:s,width:u*5,height:b}];break;case 8:r=[{x:v+u*1,y:s,width:u*2,height:b},{x:v+u*4,y:s,width:u*2,height:b},{x:v+u*7,y:s,width:u*2,height:b}];break;case 9:{r=[{x:v+u*6,y:s,width:u*2,height:b}];break}case 10:{const c={force:.3,x:v+u*1,y:s,width:u*2,height:b},f={force:.3,x:v+u*6,y:s,width:u*2,height:b};r=[c,f];break}case 11:{const c={force:.3,x:v+u*1,y:s,width:u*2,height:b},f={x:v+u*6,y:s,width:u*2,height:b};r=[c,f];break}case 12:{const c={x:v+u*1,y:s,width:u*2,height:b},f={force:.3,x:v+u*6,y:s,width:u*2,height:b};r=[c,f];break}case 13:{const c={force:.3,x:v+u*1,y:s,width:u*2,height:b},f={force:.3,x:v+u*6,y:s,width:u*2,height:b};r=[c,{x:v+u*3,y:s,width:u*3,height:b},f],l=[new A({x:v+u*4,y:n-A.HEIGHT/2})];break}case 14:{r=[{x:-90/2,y:s,width:yt,height:b}],l=[new A({x:v+u*4,y:n-A.HEIGHT/2}),new A({x:v+u*6,y:n-A.HEIGHT/2}),new A({x:v+u*8,y:n-A.HEIGHT/2})];break}case 15:{r=[{x:-90/2,y:s,width:yt,height:b}],l=[new A({x:v+u*3,y:n-A.HEIGHT/2}),new A({x:v+u*5,y:n-A.HEIGHT/2}),new A({x:v+u*7,y:n-A.HEIGHT/2})];break}case 16:r=[{x:-90/2,y:s,width:yt,height:b}],l=[new A({x:v+u*0,y:n-A.HEIGHT/2}),new A({x:v+u*2,y:n-A.HEIGHT/2}),new A({x:v+u*4,y:n-A.HEIGHT/2}),new A({x:v+u*6,y:n-A.HEIGHT/2}),new A({x:v+u*8,y:n-A.HEIGHT/2})];break;case 17:r=[{x:-90/2,y:s,width:yt,height:b}],l=[new A({x:v+u,y:n-A.HEIGHT/2}),new A({x:v+u*3,y:n-A.HEIGHT/2}),new A({x:v+u*5,y:n-A.HEIGHT/2}),new A({x:v+u*7,y:n-A.HEIGHT/2})];break;case 18:break;case 19:{a=3,r=[{yDirection:-1,dockStartTime:0,x:v+u*3,y:s,width:Qe,height:b}];break}case 20:{a=3;const c={yDirection:-1,dockStartTime:0,x:v+u*1,y:s-wt()*b,width:u*2,height:b},f={yDirection:-1,dockStartTime:0,x:Ze-u*3,y:s-wt()*b,width:u*2,height:b};r=[c,f];break}case 21:a=1,r=[{x:-90/2,y:s,width:yt,height:b}];break;case 22:a=2,r=[{x:-90/2,y:s,width:yt,height:b}];break}return new As(e,s,a,r,l)}function Ps(t){for(let e=1;e<t.length;e++){const i=t[e-1],s=t[e];for(let n=0;n<Nt;n++)i.blocks[n].type===3&&s.blocks[n].type===0&&(s.blocks[n].type=3)}}const pe=-1,Je=1,Rs={x:0,y:pe},Fs={x:-1,y:0},Ts={x:1,y:0},Os=dt({x:-1,y:pe}),Ds=dt({x:1,y:pe}),Ws=3,Ce=1e3;class _s{constructor(e,i){y(this,"host");y(this,"track");y(this,"horizontalMargin",0);y(this,"lastSlowdownTime",-1e3);y(this,"target",null);this.host=e,this.track=i}reset(){this.target=null}getMovement(e){const i=this.getCurrentBlock(),s=this.track.getBlock(i.row+1,i.col),n=this.goByRaft(i,s,e);return n||((this.target==null||this.hasReached(this.target))&&(this.target=this.findNextTarget(i)),this.goRoundObstacles(i,s,e)||this.moveOnTrack(i,s,e))}goByRaft(e,i,s){if(e.type!==D.Raft&&i.type===D.Raft&&(this.host.y>e.y+1.5*this.host.height||this.track.isFree(e.row+1,e.col)))return{x:0,y:this.moveAhead(e,i,s)};if(i.type===D.Raft&&this.host.y<=e.y+1.5*this.host.height&&!this.track.isFree(e.row+1,e.col))return J;if(e.type===D.Raft&&!this.track.isFree(e.row+1,e.col)){let n=0;return this.host.x<e.x+this.host.width?n=1:e.x+e.width-2*this.host.width<this.host.x&&(n=-1),{x:n,y:0}}return e.type===D.Raft&&this.track.isFree(e.row,e.col)&&this.track.isFree(e.row+1,e.col)?Rs:null}goRoundObstacles(e,i,s){if(this.target==null)return J;if(e.type===D.Obstacle){if(e.y+e.height/2<this.host.y+this.host.height/2)return this.target.col<e.col?Os:Ds}else{if(this.target.col<e.col&&this.track.getBlock(e.row,e.col-1).type===D.Obstacle)return this.host.y>e.y+3*this.host.height&&i.type===D.Empty?Fs:this.host.y>e.y+3*this.host.height?{x:0,y:this.moveAhead(e,i,s)}:{x:-1,y:this.moveAhead(e,i,s)};if(e.col<this.target.col&&this.track.getBlock(e.row,e.col+1).type===D.Obstacle)return this.host.y>e.y+3*this.host.height&&i.type===D.Empty?Ts:this.host.y>e.y+3*this.host.height?{x:0,y:this.moveAhead(e,i,s)}:{x:1,y:this.moveAhead(e,i,s)}}return null}moveOnTrack(e,i,s){if(this.target==null)return J;let n=0;i.type===D.Empty&&this.host.y+this.host.height/2<e.y?n=Je:n=this.moveAhead(e,i,s),n<0&&i.type===D.Empty&&this.host.y+this.host.height/2<e.y+e.height/2&&(n=0);let a=0;const r=this.host.x<this.target.x+this.horizontalMargin,l=this.target.x+this.target.width-this.horizontalMargin<=this.host.x+this.host.width;return r&&this.track.getBlock(e.row,e.col+1).type===D.Free?a=1:l&&this.track.getBlock(e.row,e.col-1).type===D.Free&&(a=-1),{x:a,y:n}}moveAhead(e,i,s){return i.type!==D.Free&&this.host.velocity.y<-.25*1.5?(Ce<s-this.lastSlowdownTime&&(this.lastSlowdownTime=s),Je):this.host.velocity.y<-.25*3.5&&!this.isClearAhead(e)?(Ce<s-this.lastSlowdownTime&&(this.lastSlowdownTime=s),0):Ce<s-this.lastSlowdownTime?pe:0}getCurrentBlock(){const e=hs(this.host);let i=this.track.getBlockAt(e);return(i.type===D.Empty||i.type===D.Raft)&&i.y+i.height-this.host.height<e.y&&(i=this.track.getBlock(i.row-1,i.col)),i.type===D.Empty&&(i.x+i.width-this.host.width<e.x?i=this.track.getBlock(i.row,i.col+1):e.x<i.x+this.host.width&&(i=this.track.getBlock(i.row,i.col-1))),i}hasReached(e){return this.host.y+this.host.height<e.y+e.height}findNextTarget(e){const i=this.findNearestBlock(e.row+1,e.col);if(i==null||i.col!==e.col)return i;const s=this.findNearestBlock(i.row+1,i.col);if(s==null)return i;if(s.col<i.col){const n=this.track.getBlock(i.row,i.col-1);if(n.type===D.Free)return n}if(i.col<s.col){const n=this.track.getBlock(i.row,i.col+1);if(n.type===D.Free)return n}return i}isClearAhead(e){for(let i=e.row+1;i<=e.row+Ws;i++)if(this.track.getBlock(i,e.col).type!==D.Free)return!1;return!0}findNearestBlock(e,i){for(let s=0;s<Nt-1;s++){const n=(wt()<.5?-1:1)*s,a=i+n,r=this.track.getBlock(e,a);if(r.type===D.Free||r.type===D.Raft)return this.horizontalMargin=wt(.2)*u,this.track.getBlock(e,a)}return null}}const ot=(t,e)=>2*Math.abs(e/t-Math.floor(e/t+.5));var gt=(t=>(t[t.Stand=0]="Stand",t[t.Walk=1]="Walk",t[t.Fall=2]="Fall",t[t.Celebrate=3]="Celebrate",t))(gt||{}),q=(t=>(t[t.Right=0]="Right",t[t.Forward=1]="Forward",t[t.Backward=2]="Backward",t[t.ForwardRight=3]="ForwardRight",t[t.BackwardRight=4]="BackwardRight",t))(q||{});const Ls="rgb(200,150,150)",Hs="rgb(230,230,230)",Bs="rgb(30,0,0)",Ns="rgb(170,120,120)",Kt="rgb(140,140,140)",Ae="rgb(120,120,120)",qt="rgb(140,140,220)",Ee="rgb(120,120,200)",Gs="rgba(0, 0, 0, 0.2";function te(t,e,i,s,n,a,r,l,c){let f=0,w=0,p=0,d=0,m=0,S=0;const I=a===3||a===4,R=a===0;switch(r){case 1:f=R?600:I?400:300,S=Ie(ot(f/2,n/2))*.02*s,w=m=-Math.PI/6+at(ot(f,n))*(Math.PI/3),p=d=-Math.PI/6+at(ot(f,n+f/2))*(Math.PI/3);break;case 3:{f=1500,S=Ie(ot(f/2,n/2))*.15*s;const k=ot(f,n);w=at(k)*Math.PI*(1/8),p=-at(k)*Math.PI*(3/8),m=Math.PI*(1/8)-at(k)*Math.PI*(9/8),d=Math.PI*(1/8)-at(k)*Math.PI*(10/8);break}case 2:f=3200,S=Ie(ot(f/2,n))*.02*s,w=-Math.PI*(3/8)+at(ot(f,n))*(Math.PI*(3/4)),p=-Math.PI*(3/8)+at(ot(f,n+f/2))*(Math.PI*(3/4)),d=-Math.PI*(8/8)+at(ot(f,n+f/2))*(Math.PI/4),m=-Math.PI*(8/8)+at(ot(f,n))*(Math.PI/4);break}t.save(),Xs(t,.5*i,s,i*.4-S/2),t.translate(0,-S);const x=.3*s,M=.25*s,C=.2*i,B=.1*i;switch(t.fillStyle=e,t.lineWidth=C,t.lineJoin="round",t.lineCap="round",e==="eliminated"&&(t.globalAlpha=.7),a){case 0:{const k=.5*i,O=.4*s,L=.5*i,G=.7*s;ii(t,Ee,k,O,B,x,d),si(t,Ae,L,G,C,M,w),si(t,Kt,L,G,C,M,p),se(a,t,i,s,e,l,c),ne(a,t,i,s,e,l,c),ii(t,qt,k,O,B,x,m)}break;case 1:case 2:{Tt(t,Kt,.35*i,.7*s,C,M,-1,w,0),Tt(t,Kt,.7*i,.7*s,C,M,1,p,0),se(a,t,i,s,e,l,c),Ft(t,qt,.25*i,.35*s,B,x,-1,d),Ft(t,qt,.75*i,.35*s,B,x,1,m),ne(a,t,i,s,e,l,c);break}case 3:{Tt(t,Ae,.35*i,.7*s,C,M,-1,w,p/4),Tt(t,Kt,.65*i,.7*s,C,M,1,p,p/4),Ft(t,Ee,.25*i,.35*s,B,x,-1,m,m/2),se(a,t,i,s,e,l,c),ne(a,t,i,s,e,l,c),Ft(t,qt,.75*i,.35*s,B,x,1,d,m/2);break}case 4:{Tt(t,Ae,.65*i,.7*s,C,M,1,p,p/4),Tt(t,Kt,.35*i,.7*s,C,M,-1,w,p/4),Ft(t,Ee,.75*i,.35*s,B,x,1,m,m/2),se(a,t,i,s,e,l,c),ne(a,t,i,s,e,l,c),Ft(t,qt,.25*i,.35*s,B,x,-1,d,m/2);break}}t.restore()}function Xs(t,e,i,s){t.save(),t.fillStyle=Gs,t.translate(e,i),t.beginPath(),t.arc(0,0,Math.max(0,s),0,2*Math.PI),t.fill(),t.restore()}const Wt={};function ut(t,e,i){const s=ti(t),n=ti(e),a=Math.round((1-i)*s.r+i*n.r),r=Math.round((1-i)*s.g+i*n.g),l=Math.round((1-i)*s.b+i*n.b);return`rgb(${a}, ${r}, ${l})`}function ti(t){if(t==="eliminated")return{r:128,g:128,b:128};const e=/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/.exec(t);return e?{r:parseInt(e[1]),g:parseInt(e[2]),b:parseInt(e[3])}:{r:0,g:0,b:0}}const Ys=navigator.userAgent.toLowerCase().includes("firefox");function Ti(t,e,i,s,n,a){const r=`${i}-${e}-${s}-${n}`;if(a||!Wt[r]){const l=t.createRadialGradient(s,n,n/8,s,n,s);if(i==="TORSO"?(l.addColorStop(0,ut(e,"rgb(255, 255, 255)",.1)),l.addColorStop(.2,ut(e,"rgb(255, 255, 255)",.1)),l.addColorStop(.5,ut(e,"rgb(0, 0, 0)",.1)),l.addColorStop(1,ut(e,"rgb(0, 0, 0)",.3))):i==="HEAD"&&(l.addColorStop(0,ut(e,"rgb(0, 0, 0)",.3)),l.addColorStop(.5,ut(e,"rgb(0, 0, 0)",.1)),l.addColorStop(.8,ut(e,"rgb(255, 255, 255)",.1)),l.addColorStop(1,ut(e,"rgb(255, 255, 255)",.1))),Ys){if(a)return ei(t,l,s*2,n*2);Wt[r]=ei(t,l,s*2,n*4)}else{if(a)return l;Wt[r]=l}}return Wt[r]}function $s(){for(const t in Wt)delete Wt[t]}function ei(t,e,i,s){const n=document.createElement("canvas");n.width=i,n.height=s;const a=n.getContext("2d");if(a)return a.fillStyle=e,a.fillRect(0,0,i,s),t.createPattern(n,"no-repeat")}function Oi(t,e,i,s,n,a){e&&(t.save(),t.translate(i,s),t.scale(n/80,a/80),t.fillStyle=e,t.fill(),t.restore())}function se(t,e,i,s,n,a,r=!1){const l=.2*i,c=t===0?.5*i:.45*i,f=.25*s,w=t===0?.28*i:.5*(i-c),p=.06*s;e.beginPath(),e.roundRect(w,p,c,f,l);const d=Ti(e,n,"HEAD",c,f,r);e.fillStyle=d||"black",e.fill(),Oi(e,a,w,p,c,f),zs(e,t,i,c,f,l)}function ne(t,e,i,s,n,a,r=!1){const l=.4*s,c=.2*i,f=t===0?.5*i:.6*i,w=t===1||t===2?.2*i:.5*(i-f),p=.3*s;e.beginPath(),e.roundRect(w,p,f,l,c);const d=Ti(e,n,"TORSO",f,l,r);e.fillStyle=d||"black",e.fill(),Oi(e,a,w,p,f,l)}function ii(t,e,i,s,n,a,r){t.save(),t.strokeStyle=e,t.lineWidth=n,t.translate(i,s),t.rotate(r),t.beginPath(),t.moveTo(0,0),t.quadraticCurveTo(-a/4,a/2,0,a),t.stroke(),t.restore()}function si(t,e,i,s,n,a,r){t.save(),t.strokeStyle=e,t.lineWidth=n,t.translate(i,s),t.rotate(r),t.beginPath(),t.moveTo(0,0),t.quadraticCurveTo(-a/8,a/2,0,a),t.stroke(),t.restore()}function Ft(t,e,i,s,n,a,r,l,c=0){t.save(),t.strokeStyle=e,t.lineWidth=n,t.translate(i,s),t.rotate(-r*.07*Math.PI),t.rotate(c),t.scale(1,Math.cos(l+Math.PI/8)),t.beginPath(),t.moveTo(0,0),t.quadraticCurveTo(r*a/4,a/2,0,a),t.stroke(),t.restore()}function Tt(t,e,i,s,n,a,r,l,c){t.save(),t.strokeStyle=e,t.lineWidth=n,t.translate(i,s),t.rotate(c),t.scale(1,Math.cos(l+Math.PI/8)),t.beginPath(),t.moveTo(0,0),t.quadraticCurveTo(r*a/8,a/2,0,a),t.stroke(),t.restore()}function zs(t,e,i,s,n,a){if(e!==2&&e!==4)return;const r=.15*i,l=.6*a,c=s-r,f=n-r*1.75,w=n-f,p=e===2?(i-c)/2:(i-c)/2+(s-c)/2;t.save(),t.translate(p,w),t.shadowColor="rgba(0, 0, 0, 0.5)",t.fillStyle=Ls,t.shadowOffsetY=-f/10;const d=0,m=0;t.beginPath(),t.roundRect(d,m,c,f,l),t.fill(),t.closePath(),t.shadowOffsetY=0;const S=.06*c,I=c/4,R=f/3,x=d+I,M=d+c-I,C=m+R;t.fillStyle=Hs,t.beginPath(),t.arc(x,C,S,0,Math.PI*2),t.arc(M,C,S,0,Math.PI*2),t.fill(),t.closePath();const B=.025*c,k=.01*c,O=.01*f;t.fillStyle=Bs,t.beginPath(),t.arc(x+k,C+O,B,0,Math.PI*2),t.arc(M+k,C+O,B,0,Math.PI*2),t.fill(),t.closePath();const L=.15*c,G=.2*f,F=d+(c-L)/1.75,K=m+(f-G)/1.5;t.fillStyle=Ns,t.beginPath(),t.moveTo(F,K),t.lineTo(F+L/2,K+G),t.lineTo(F-L/2,K+G),t.closePath(),t.fill(),t.restore()}const Us=[1,,82,.01,.08,.2,,2.6,,,,,,.1,,,,.61,.02,,-1686],Vs=[2,,12,,,.008,,1.2,23,-7,,,.05,.4,,,.15,.82,.03,.28],Ks=[1,,85,.08,.1,.01,1,4,,-11,1,.07,,.1,101,,.05,.68,.4,.12,1],qs=[.01,,523.2511,.1,3,3,4,0,,,2250,,.04,,10,.01,,.82,1,,30],js=[2,,185,,,,3,1.6,-7,,,,,,,.2,.19,.1,,.38,985],Qs=[1.5,,688,.02,.01,.007,1,2.6,,,,,.01,,85,,.01,.85,.03,.11,-818],Zs=[1.5,,1376,.02,.01,.007,1,2.6,,,,,.01,,85,,.01,.85,.8,.11,-818],Js={songData:[{i:[0,0,180,0,0,0,180,0,0,160,158,158,158,0,0,0,0,51,2,1,2,54,239,1,32,88,1,157,2],p:[1,2],c:[{n:[111,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,137],f:[]},{n:[],f:[]}]}],rowLen:5513,patternLen:32,endPattern:1,numChannels:1},tn={songData:[{i:[1,127,128,0,1,127,116,9,0,0,6,22,34,0,96,2,0,69,3,1,1,0,167,0,20,125,6,25,6],p:[4,1,2,3,2,1,2,3],c:[{n:[134,134,136,134,136,136,134,138,139,141,141,134,146,134,146,134,137,137,139,137,139,139,137,141,142,144,144,137,149,137,149,137],f:[]},{n:[141,141,143,141,143,143,141,145,146,148,148,141,129,141,129,141,141,141,143,141,143,143,141,145,146,148,148,141,129,141,129,141],f:[]},{n:[137,137,139,137,139,139,137,141,142,144,144,137,149,137,149,137,134,134,136,134,136,136,134,138,139,141,141,134,146,134,146,134],f:[]},{n:[141,141,143,141,143,143,141,145,146,148,148,141,129,141,129,141,141,141,143,141,143,143,141,145,146,148,148,141,129,141,129,141],f:[]}]},{i:[3,255,128,0,2,255,128,6,0,0,12,12,33,0,0,0,0,61,4,1,2,109,86,7,32,112,3,67,2],p:[27,1,27,2,27,1,27,2],c:[{n:[98,,98,,98,,98,,98,,98,,98,,98,,101,,101,,101,,101,,101,,101,,101,,101],f:[]},{n:[101,,101,,101,,101,,101,,101,,101,,101,,98,,98,,98,,98,,98,,98,,98,,98],f:[]},{n:[101,,101,,101,,101,,101,,101,,101,,101,,98,,98,,98,,98,,98,,98,,98],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101],f:[]},{n:[101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101],f:[]},{n:[105,,105,,105,,105,,105,,105,,105,,105,,105,,105,,105,,105,,105,,105,,105,,105],f:[]}]},{i:[0,255,116,79,0,255,116,0,83,0,4,6,69,52,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[1,1,1,1,1,1,1,2],c:[{n:[135,,,,135,,,,135,,,,135,,,,135,,,,135,,,,135,,,,135,,135,135],f:[]},{n:[135,,,,135,,,,135,,,,135,,,,135,,,,135,,,,135],f:[]}]},{i:[3,0,128,0,3,68,128,0,64,85,4,4,53,68,0,0,1,55,4,0,2,67,115,124,190,67,6,39,1],p:[],c:[]},{i:[1,128,128,0,1,130,116,9,0,0,128,22,159,0,203,2,0,69,3,1,1,23,167,0,32,192,6,25,3],p:[],c:[]},{i:[0,214,104,64,0,204,104,0,64,56,7,40,93,51,0,0,0,231,6,0,3,143,15,0,16,0,4,0,6],p:[1],c:[{n:[147],f:[]}]},{i:[0,0,128,0,0,0,128,0,0,63,0,1,59,0,0,0,0,0,0,0,1,193,171,0,29,39,3,88,3],p:[],c:[]},{i:[0,214,104,64,0,204,104,0,64,124,96,40,0,0,0,0,0,231,6,0,3,143,15,0,16,0,4,0,6],p:[,,,,,,,1],c:[{n:[,,,,,,,,,,,,,,,,,,,,,,,,135],f:[]}]}],rowLen:4725,patternLen:32,endPattern:7,numChannels:8},en={songData:[{i:[1,127,128,0,1,127,116,9,0,0,6,22,34,0,96,2,0,69,3,1,1,0,167,0,20,125,6,25,6],p:[],c:[]},{i:[3,255,128,0,2,255,128,6,0,0,12,12,33,0,0,0,0,61,4,1,2,109,86,7,32,112,3,67,2],p:[25,27,1,27,2,27,1,27,2,27,1,27,2,27,1,27,2,27,1,27,3,26,26,26],c:[{n:[98,,98,,98,,98,,98,,98,,98,,98,,101,,101,,101,,101,,101,,101,,101,,101],f:[]},{n:[101,,101,,101,,101,,101,,101,,101,,101,,98,,98,,98,,98,,98,,98,,98,,98],f:[]},{n:[101,,101,,101,,101,,101,,101,,101,,101,,98,,98,,98,,98,,98,,98,,98],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101],f:[]},{n:[101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101,,101],f:[]},{n:[105,,105,,105,,105,,105,,105,,105,,105,,105,,105,,105,,105,,105,,105,,105,,105],f:[]}]},{i:[0,255,116,79,0,255,116,0,83,0,4,6,69,52,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[2,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,2,1,1,1,,1,1,1],c:[{n:[135,,,,135,,,,135,,,,135,,,,135,,,,135,,,,135,,,,135,,135,135],f:[]},{n:[135,,,,135,,,,135,,,,135,,,,135,,,,135,,,,135],f:[]}]},{i:[3,0,128,0,3,68,128,0,64,85,4,4,53,68,0,0,1,55,4,0,2,67,115,124,190,67,6,39,1],p:[,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],c:[{n:[,,,,135,,,,,,,,135,,,,,,,,135,,,,,,,,135,,135],f:[]}]},{i:[1,128,128,0,1,130,116,9,0,0,128,22,159,0,203,2,0,69,3,1,1,23,167,0,32,192,6,25,3],p:[5,1,2,4,3,1,2,4,3,1,2,4,3,1,2,4,3,1,2,4,3,5,,5],c:[{n:[129],f:[]},{n:[134,,,,,,,,,,,,,,,,137],f:[]},{n:[137,,,,,,,,,,,,,,,,134],f:[]},{n:[141],f:[]},{n:[113],f:[]}]},{i:[0,214,104,64,0,204,104,0,64,56,7,40,93,51,0,0,0,231,6,0,3,143,15,0,16,0,4,0,6],p:[,1,,,,1,,,,1,,,,1,,,,1,,,,1],c:[{n:[147],f:[]}]},{i:[0,0,128,0,0,0,128,0,0,63,0,1,59,0,0,0,0,0,0,0,1,193,171,0,29,39,3,88,3],p:[,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,,1,1,1],c:[{n:[,,149,,,,149,,,,149,,,,149,,,,149,,,,149,,,,149,,,,149],f:[]}]},{i:[0,214,104,64,0,204,104,0,64,124,96,40,0,0,0,0,0,231,6,0,3,143,15,0,16,0,4,0,6],p:[1,,,,1,,,,1,,,,1,,,,1],c:[{n:[,,,,,,,,,,,,,,,,,,,,,,,,135],f:[]}]}],rowLen:4725,patternLen:32,endPattern:23,numChannels:8},mt=(t,...e)=>nn(t,an(t,...e)),j=44100,sn=new(window.AudioContext||window.webkitAudioContext),Me=sn,nn=(t,...e)=>{let i=Me.createBuffer(e.length,e[0].length,j),s=Me.createBufferSource();return e.forEach((n,a)=>i.getChannelData(a).set(n)),s.buffer=i,s.connect(Me.destination),s.start(),s},an=(t,e=.1,i=.05,s=220,n=0,a=0,r=.1,l=0,c=1,f=0,w=0,p=0,d=0,m=0,S=0,I=0,R=0,x=0,M=1,C=0,B=0,k=0)=>{let O=Math.PI*2,L=Zi=>Zi<0?-1:1,G=f*=500*O/j/j,F=s*=(1+i*2*Math.random()-i)*O/j,K=[],Y=0,vt=0,W=0,tt=1,nt=0,Q=0,N=0,z,Z,Mt=2,St=O*Math.abs(k)*2/j,Yt=Math.cos(St),$t=Math.sin(St)/2/Mt,Pt=1+$t,be=-2*Yt/Pt,zt=(1-$t)/Pt,ie=(1+L(k)*Yt)/2/Pt,ve=-(L(k)+Yt)/Pt,Se=ie,Ut=0,Rt=0,Vt=0,Ve=0;for(n=n*j+9,C*=j,a*=j,r*=j,x*=j,w*=500*O/j**3,I*=O/j,p*=O/j,d*=j,m=m*j|0,e*=t<0?0:t,Z=n+C+a+r+x|0;W<Z;K[W++]=N*(t<0?0:t))++Q%(R*100|0)||(N=l?l>1?l>2?l>3?Math.sin(Y**3):Math.max(Math.min(Math.tan(Y),1),-1):1-(2*Y/O%2+2)%2:1-4*Math.abs(Math.round(Y/O)-Y/O):Math.sin(Y),N=(m?1-B+B*Math.sin(O*W/m):1)*L(N)*Math.abs(N)**c*(W<n?W/n:W<n+C?1-(W-n)/C*(1-M):W<n+C+a?M:W<Z-x?(Z-W-x)/r*M:0),N=x?N/2+(x>W?0:(W<Z-x?1:(Z-W)/x)*K[W-x|0]/2/e):N,k&&(N=Ve=Se*Ut+ve*(Ut=Rt)+ie*(Rt=N)-zt*Vt-be*(Vt=Ve))),z=(s+=f+=w)*Math.cos(I*vt++),Y+=z+z*S*Math.sin(W**5),tt&&++tt>d&&(s+=p,F+=p,tt=0),m&&!(++nt%m)&&(s=F,f=G,tt=tt||1);return K};function on(){var t=function(d){return Math.sin(d*6.283184)},e=function(d){return 2*(d%1)-1},i=function(d){return d%1<.5?1:-1},s=function(d){var m=d%1*4;return m<2?m-1:3-m},n=function(d){return .003959503758*2**((d-128)/12)},a=function(d,m,S){var I=r[d.i[0]],R=d.i[1],x=d.i[3]/32,M=r[d.i[4]],C=d.i[5],B=d.i[8]/32,k=d.i[9],O=d.i[10]*d.i[10]*4,L=d.i[11]*d.i[11]*4,G=d.i[12]*d.i[12]*4,F=1/G,K=-d.i[13]/16,Y=d.i[14],vt=S*2**(2-d.i[15]),W=new Int32Array(O+L+G),tt=0,nt=0,Q,N,z,Z,Mt,St;for(Q=0,N=0;Q<O+L+G;Q++,N++)N>=0&&(Y=Y>>8|(Y&255)<<4,N-=vt,Mt=n(m+(Y&15)+d.i[2]-128),St=n(m+(Y&15)+d.i[6]-128)*(1+8e-4*d.i[7])),z=1,Q<O?z=Q/O:Q>=O+L&&(z=(Q-O-L)*F,z=(1-z)*3**(K*z)),tt+=Mt*z**x,Z=I(tt)*R,nt+=St*z**B,Z+=M(nt)*C,k&&(Z+=(2*Math.random()-1)*k),W[Q]=80*Z*z|0;return W},r=[t,i,e,s],l,c,f,w,p;this.init=function(d){l=d,c=d.endPattern,f=0,w=d.rowLen*d.patternLen*(c+1)*2,p=new Int32Array(w)},this.generate=function(){var d,m,S,I,R,x,M,C,B,k,O,L,G=new Int32Array(w),F=l.songData[f],K=l.rowLen,Y=l.patternLen,vt=0,W=0,tt,nt,Q=!1,N=[];for(S=0;S<=c;++S)for(M=F.p[S],I=0;I<Y;++I){var z=M?F.c[M-1].f[I]:0;z&&(F.i[z-1]=F.c[M-1].f[I+Y]||0,z<17&&(N=[]));var Z=r[F.i[16]],Mt=F.i[17]/512,St=2**(F.i[18]-9)/K,Yt=F.i[19],$t=F.i[20],Pt=F.i[21]*43.23529*3.141592/44100,be=1-F.i[22]/255,zt=F.i[23]*1e-5,ie=F.i[24]/32,ve=F.i[25]/512,Se=6.283184*2**(F.i[26]-9)/K,Ut=F.i[27]/255,Rt=F.i[28]*K&-2;for(O=(S*Y+I)*K,R=0;R<4;++R)if(x=M?F.c[M-1].n[I+R*Y]:0,x){N[x]||(N[x]=a(F,x,K));var Vt=N[x];for(m=0,d=O*2;m<Vt.length;m++,d+=2)G[d]+=Vt[m]}for(m=0;m<K;m++)C=(O+m)*2,k=G[C],k||Q?(L=Pt,Yt&&(L*=Z(St*C)*Mt+.5),L=1.5*Math.sin(L),vt+=L*W,tt=be*(k-W)-vt,W+=L*tt,k=$t==3?W:$t==1?tt:vt,zt&&(k*=zt,k=k<1?k>-1?t(k*.25):-1:1,k/=zt),k*=ie,Q=k*k>1e-5,B=Math.sin(Se*C)*ve+.5,nt=k*(1-B),k*=B):nt=0,C>=Rt&&(nt+=G[C-Rt+1]*Ut,k+=G[C-Rt]*Ut),G[C]=nt|0,G[C+1]=k|0,p[C]+=nt|0,p[C+1]+=k|0}return f++,f/l.numChannels},this.createAudioBuffer=function(d){for(var m=d.createBuffer(2,w/2,44100),S=0;S<2;S++)for(var I=m.getChannelData(S),R=S;R<w;R+=2)I[R>>1]=p[R]/65536;return m},this.createWave=function(){var d=44,m=d+w*2-8,S=m-36,I=new Uint8Array(d+w*2);I.set([82,73,70,70,m&255,m>>8&255,m>>16&255,m>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,S&255,S>>8&255,S>>16&255,S>>24&255]);for(var R=0,x=d;R<w;++R){var M=p[R];M=M<-32767?-32767:M>32767?32767:M,I[x++]=M&255,I[x++]=M>>8&255}return I},this.getData=function(d,m){for(var S=2*Math.floor(d*44100),I=new Array(m),R=0;R<2*m;R+=1){var x=S+R;I[R]=d>0&&x<p.length?p[x]/32768:0}return I}}const De="start",Di="race",Wi="bounce",_i="hit",Li="teleport",We="keyboard",Hi="finished",Bi="gameover",ge="restart",_e="count",Ni="go",et=document.createElement("audio"),pt=document.createElement("audio"),ee=document.createElement("audio"),rn=[et,pt,ee];let T;try{T=new(window.AudioContext||window.webkitAudioContext),console.log("AudioContext created successfully.")}catch(t){console.error("Web Audio API is not supported in this browser.",t),T={resume:()=>Promise.resolve(),createBufferSource:()=>({start:()=>{},connect:()=>{}}),createGain:()=>({gain:{value:0},connect:()=>{}}),destination:null,state:"closed"}}let Le=!1,ni=null;const Pe=(t,e,i)=>new Promise(s=>{const n=new on;n.init(e);let a=!1;function r(){if(!a)if(a=n.generate()>=1,a){const l=n.createWave();t.src=URL.createObjectURL(new Blob([l],{type:"audio/wav"})),t.loop=i,console.log(`Music generated for: ${t===et?"startTune":t===pt?"raceTune":"gameoverFx"}`),s()}else requestAnimationFrame(r)}r()}),ln=()=>(console.log("Initializing SFX system..."),Promise.all([Pe(et,tn,!0),Pe(pt,en,!0),Pe(ee,Js,!1)]).then(()=>{console.log("SFX initialization complete.")})),hn=(t,e=0)=>{t._fadeInterval&&clearInterval(t._fadeInterval),t._fadeInterval=null;let i=t.volume;i>e?(console.log(`FadeOut: Starting fade out for ${t.src.substring(0,50)} from ${i}`),t._fadeInterval=setInterval(()=>{i=Math.max(e,parseFloat(i)-.1).toFixed(1),t.volume=i,i<=e&&(e===0&&!t.paused&&(console.log(`FadeOut: Pausing ${t.src.substring(0,50)}`),t.pause()),clearInterval(t._fadeInterval),t._fadeInterval=null,console.log(`FadeOut: Finished for ${t.src.substring(0,50)} at volume ${t.volume}`))},100)):e===0&&!t.paused&&(console.log(`FadeOut: Pausing immediately ${t.src.substring(0,50)}`),t.pause(),t.volume=0)},He=(t,e=1)=>{t._fadeInterval&&clearInterval(t._fadeInterval),t._fadeInterval=null;let i=Promise.resolve();t.paused?(t.volume=0,console.log(`FadeIn: Attempting to play ${t.src.substring(0,50)}`),i=t.play()):console.log(`FadeIn: Already playing ${t.src.substring(0,50)}, adjusting volume.`),i.then(()=>{console.log(`FadeIn: Play successful or already playing ${t.src.substring(0,50)}`);let s=t.volume;s<e?t._fadeInterval=setInterval(()=>{s=Math.min(e,parseFloat(s)+.1).toFixed(1),t.volume=s,parseFloat(s)>=e&&(t.volume=e,clearInterval(t._fadeInterval),t._fadeInterval=null,console.log(`FadeIn: Finished for ${t.src.substring(0,50)} at volume ${t.volume}`))},100):(t.volume=e,console.log(`FadeIn: Volume already >= target for ${t.src.substring(0,50)}, set to ${t.volume}`))}).catch(s=>{console.error(`FadeIn play() FAILED for ${t.src.substring(0,50)}:`,s.name,s.message),t._fadeInterval&&clearInterval(t._fadeInterval),t._fadeInterval=null})},ai=(t,e)=>{t._fadeInterval&&clearInterval(t._fadeInterval),t._fadeOutInTimeout&&clearTimeout(t._fadeOutInTimeout),e._fadeInterval&&clearInterval(e._fadeInterval),e._fadeOutInTimeout&&clearTimeout(e._fadeOutInTimeout),console.log(`FadeOutIn: Fading out ${t.src.substring(0,50)}, preparing ${e.src.substring(0,50)}`);let s=t.volume;const n=()=>{console.log(`FadeOutIn: Delay finished, calling FadeIn for ${e.src.substring(0,50)}`),He(e,1),t._fadeOutInTimeout=null};s>0?t._fadeInterval=setInterval(()=>{s=Math.max(0,parseFloat(s)-.1).toFixed(1),t.volume=s,s<=0&&(t.paused||t.pause(),clearInterval(t._fadeInterval),t._fadeInterval=null,t._fadeOutInTimeout=setTimeout(n,50))},100):(t.paused||t.pause(),t.volume=0,t._fadeOutInTimeout=setTimeout(n,50))};function cn(){if(!T||T.state!=="running"){console.warn("Keep-alive: AudioContext not running or not available.");return}const t=T.createBuffer(1,1,T.sampleRate),e=T.createBufferSource();e.buffer=t,e.connect(T.destination),e.start()}function ae(){return new Promise(t=>{if(Le){console.log("Unlock: Audio already unlocked."),t();return}if(!T){console.error("Unlock: AudioContext not available."),t();return}console.log("Unlock: Attempting to unlock audio...");const e=[];if(T.state==="suspended"){console.log("Unlock: Resuming suspended AudioContext...");const s=T.resume().then(()=>console.log("Unlock: AudioContext resumed successfully.")).catch(n=>console.error("Unlock: Failed to resume AudioContext:",n));e.push(s)}else console.log(`Unlock: AudioContext state is '${T.state}'.`);const i=(T.state==="running"?Promise.resolve():T.resume()).then(()=>{try{console.log("Unlock: Playing silent zzfx sound..."),mt(0,0,0,.01,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,T),console.log("Unlock: zzfx unlock sound played.")}catch(s){console.error("Unlock: Error playing zzfx unlock sound:",s)}}).catch(()=>{});e.push(i),rn.forEach(s=>{if(!s.paused){console.log("Unlock: Skipping already playing HTML element:",s.src.substring(0,50));return}const n=s.volume;s.volume=0;const a=s.play();if(a!==void 0){const r=a.then(()=>{s.pause(),s.volume=n,console.log("Unlock: Unlocked HTMLAudioElement:",s.src.substring(0,50))}).catch(l=>{console.warn("Unlock: Error unlocking HTMLAudioElement:",l.name,l.message,s.src.substring(0,50)),s.pause(),s.volume=n});e.push(r)}}),Promise.allSettled(e).then(()=>{console.log(`Unlock: Audio unlock process finished. AudioContext state: ${T.state}`),Le=!0,T.state==="running"&&!ni?(ni=setInterval(cn,15e3),console.log("Unlock: Web Audio keep-alive interval started.")):T.state!=="running"&&console.warn("Unlock: Cannot start keep-alive, AudioContext not running."),t()})})}const st=(t,e=1)=>{if(!Le&&![De,ge,We].includes(t)){console.warn(`playTune (${t}): Called before audio unlock completed. Skipping.`);return}T&&T.state==="suspended"&&(console.log(`playTune (${t}): Resuming suspended context before zzfx...`),T.resume().catch(s=>console.warn(`playTune (${t}): Failed to resume context:`,s))),console.log(`playTune called: ${t}, vol: ${e}`);const i=typeof e=="number"?e:1;switch(t){case Di:pt.currentTime=0,ai(et,pt);break;case Hi:mt(.04,...qs,T),et.currentTime=0,ai(pt,et);break;case Bi:ee.volume=1,ee.play().catch(s=>console.error("playTune SFX_GAMEOVER play() FAILED:",s.name,s.message)),hn(pt);break;case ge:et.currentTime=0,He(et);break;case De:et.volume=0,et.currentTime=0,He(et);break;case Wi:mt(i,...Us,T);break;case _i:mt(i,...js,T);break;case We:mt(.5,...Vs,T);break;case Li:mt(i,...Ks,T);break;case _e:mt(.5,...Qs,T);break;case Ni:mt(.5,...Zs,T);break;default:console.warn(`playTune: Unknown tune ${t}`);break}},oi=t=>{const e=[];e.push(et,pt,ee),console.log("stopTune called for: all"),e.forEach(i=>{i._fadeInterval&&clearInterval(i._fadeInterval),i._fadeOutInTimeout&&clearTimeout(i._fadeOutInTimeout),i._fadeInterval=null,i._fadeOutInTimeout=null,i.paused||(console.log(`stopTune: Pausing ${i.src.substring(0,50)}`),i.pause()),i.currentTime=0})};let Be=1;const Gi=(t,e)=>{const i=t/e;let s=window.innerWidth,n=window.innerHeight;s/n>i?s=n*i:n=s/i,s>t&&(s=t,n=t/i),n>e&&(n=e,s=e*i),g.width=s,g.height=n;const a=window.innerWidth/s,r=window.innerHeight/n,l=Math.min(a,r);Be=l,g.style.position="absolute",g.style.left=`${(window.innerWidth-s*l)/2}px`,g.style.top=`${(window.innerHeight-n*l)/2}px`,g.style.transform=`scale(${l})`,g.style.transformOrigin="top left"},fn=(t,e)=>{const i=g.getBoundingClientRect();t.x=(e.clientX-i.left)/Be,t.y=(e.clientY-i.top)/Be},Xi=4;let Ne=0;const Yi=[...Array(Xi)].map(()=>({x:0,y:0})),bt="ontouchstart"in window,dn=()=>{bt&&(window.oncontextmenu=t=>{t.preventDefault()},g.ontouchstart=t=>{t.preventDefault(),Re(t)},g.ontouchmove=t=>{t.preventDefault(),Re(t)},g.ontouchend=t=>{t.preventDefault(),Re(t)})},Re=t=>{Ne=Math.min(t.touches.length,Xi);for(let e=0;e<Ne;e++)fn(Yi[e],t.touches[e])},oe=t=>{for(let e=0;e<Ne;e++)if(cs(t,Yi[e]))return!0;return!1};let gn=0;const Ct={symbol:"◁",x:0,y:0,width:0,height:0},_t={symbol:"▷",x:0,y:0,width:0,height:0},Lt={symbol:"△",x:0,y:0,width:0,height:0},Ht={symbol:"▽",x:0,y:0,width:0,height:0},Ge={movement:{x:0,y:0}},un=()=>{const t=ls(),e=t.ArrowLeft||t.KeyA||oe(Ct),i=t.ArrowRight||t.KeyD||oe(_t),s=t.ArrowUp||t.KeyW||oe(Lt),n=t.ArrowDown||t.KeyS||oe(Ht),a=e?-1:i?1:0,r=s?-1:n?1:0;a===0&&r===0?Ge.movement=J:Ge.movement=dt({x:a,y:r})},yn=()=>{rs(),dn(),ri(),window.addEventListener("resize",ri,!1)},ri=()=>{const t=g.width*.01,e=g.height*.02,i=g.width*.1,s=g.height*.6,n=g.height-s*.65-2*e,a=i,r=s/3;Ct.x=t,Ct.y=n+r+e,Ct.width=i,Ct.height=s/3,_t.x=i+2*t,_t.y=n+r+e,_t.width=i,_t.height=s/3,Lt.x=g.width-a-t,Lt.y=n,Lt.width=a,Lt.height=r,Ht.x=g.width-a-t,Ht.y=n+r+e,Ht.width=a,Ht.height=r},Ot=t=>new Promise(e=>{const i=async a=>{a&&(a.preventDefault(),a.stopPropagation()),window.removeEventListener("keydown",s),g.removeEventListener("pointerdown",n),g.removeEventListener("touchstart",n),st(We),e()},s=a=>{(a.key==="Enter"||a.key===" "||a.key==="Spacebar")&&i(a)},n=a=>{i(a)};bt?g.addEventListener("pointerdown",n,{once:!0,passive:!1}):window.addEventListener("keydown",s,{once:!0})}),Zt=(t="continue",e=7.7)=>{const i=(bt?"Tap the screen to ":"Press ENTER to ")+t;H(i+(gn++%60===0?"":"█"),_.Small,"Courier New",1,e,!0,0,i)},$i=()=>{if(!bt)return;o.save();const t=Ct.width/2;o.font=t+"px Impact",o.fillStyle="rgba(200, 200, 200, 0.2)",re(Ct,t),re(_t,t),re(Lt,t),re(Ht,t),o.restore()},re=(t,e)=>{o.strokeStyle="rgba(255, 255, 255, 0.2)",o.lineWidth=2,o.strokeRect(t.x,t.y,t.width,t.height),o.fillStyle="rgba(255, 255, 255, 0.4)",o.fillText(t.symbol,t.x+t.width/2-e/2,t.y+t.height/2+e*.45,e)},mn=()=>Ge;function pn(t,e){t.translate(e/2,0),t.scale(-1,1),t.translate(-e/2,0)}const ue=500,li=1e3,zi=["rgb(255, 255, 0)","rgb(255, 0, 0)","rgb(0, 128, 0)","rgb(0, 0, 255)","rgb(255, 165, 0)","rgb(255, 99, 71)","rgb(255, 192, 203)","rgb(106, 90, 205)","rgb(238, 130, 238)","rgb(30, 144, 255)","rgb(0, 255, 255)","rgb(255, 0, 255)","rgb(144, 238, 144)","rgb(211, 211, 211)","rgb(64, 224, 208)","rgb(0, 191, 255)","rgb(173, 216, 230)","rgb(240, 128, 128)","rgb(0, 255, 127)","rgb(255, 0, 255)","rgb(220, 20, 60)","rgb(230, 230, 250)","rgb(255, 127, 80)","rgb(0, 128, 128)","rgb(75, 0, 130)","rgb(250, 128, 114)","rgb(127, 255, 0)","rgb(218, 165, 32)","rgb(255, 182, 193)","rgb(210, 105, 30)","rgb(205, 92, 92)","rgb(128, 128, 0)","rgb(255, 69, 0)","rgb(135, 206, 235)","rgb(72, 209, 204)","rgb(160, 82, 45)","rgb(0, 255, 0)","rgb(0, 0, 128)","rgb(245, 222, 179)","rgb(70, 130, 180)","rgb(255, 255, 255)"],Ue=zi[0],Xe={width:2,height:2};class Fe{constructor(e,i,s=1+Math.random()*.6,n=1+Math.random()*.4){y(this,"ai");y(this,"rank",0);y(this,"finished",!1);y(this,"eliminated",!1);y(this,"timeOffset",wt(2e3));y(this,"direction",J);y(this,"latestDirection",{x:0,y:-1});y(this,"color");y(this,"x",0);y(this,"y",0);y(this,"width");y(this,"height");y(this,"velocity",J);y(this,"fallStartTime");y(this,"dropStartTime");y(this,"latestCheckpointIndex",0);this.ai=e===0||!i?null:new _s(this,i),this.color=zi[e],this.width=Xe.width*s,this.height=Xe.height*n}get doesNotCollide(){return this.finished||this.eliminated||this.fallStartTime!=null}isVisible(e){return!(this.fallStartTime!=null&&ue<e-this.fallStartTime)}setDirection(e){this.direction=e,he(e)||(this.latestDirection=e)}getMovement(e){return this.ai?this.ai.getMovement(e):mn().movement}move(){this.eliminated||this.finished?(this.direction=J,this.velocity=J):(this.x+=this.velocity.x,this.y+=this.velocity.y)}stop(){this.y+=this.velocity.y*8}drop(e,i){var s;this.x=i.x,this.y=i.y,this.direction=J,this.latestDirection={x:0,y:-1},this.velocity=J,this.fallStartTime=void 0,this.dropStartTime=e,(s=this.ai)==null||s.reset()}draw(e,i,s){const n=this.latestDirection.y!==0?this.latestDirection.x===0?this.latestDirection.y<0?q.Forward:q.Backward:this.latestDirection.y>0?q.BackwardRight:q.ForwardRight:q.Right;o.save();const a=this.height*3,r=a-this.height;if(o.translate(this.x,this.y-r),this.latestDirection.x<0&&pn(o,this.width),this.fallStartTime!=null){const c=Math.max(1-ke((e-this.fallStartTime)/ue),0);o.translate(this.width/2,a/2),o.scale(c,c),o.translate(-this.width/2,-a/2),o.globalAlpha=ke(c)}else this.dropStartTime&&e-this.dropStartTime<li&&(o.globalAlpha=ke((e-this.dropStartTime)/li));const l=he(this.direction)&&this.fallStartTime==null?0:e+this.timeOffset;te(o,this.eliminated?"eliminated":this.color,this.width,a,l,this.finished?e%3600<1800?q.Backward:q.BackwardRight:n,this.getAnimation(),s),o.restore()}getAnimation(){return this.fallStartTime!=null?gt.Fall:he(this.direction)?gt.Stand:gt.Walk}}const wn=.005,hi=2e3;class bn{constructor(e,i){y(this,"elements");y(this,"startY");y(this,"checkpoints");y(this,"specialElements");y(this,"finishY");y(this,"elementCount");y(this,"width");y(this,"height");this.elements=Es(e,i),this.elementCount=this.elements.length,this.specialElements=this.elements.filter(a=>a.surfaces.some(r=>de(r)||Oe(r))),this.startY=i,this.finishY=this.startY-(this.elements.length-1)*b;const s=Math.min(...this.elements.map(a=>a.minX)),n=Math.max(...this.elements.map(a=>a.maxX));this.width=n-s,this.height=this.elements.length*b,this.checkpoints=this.elements.filter((a,r)=>a.type===ht.CheckPoint||r===0).map(a=>({y:a.y+a.height,element:a}))}update(e,i,s){for(let n=0;n<this.specialElements.length;n++){const a=this.specialElements[n];for(let r=0;r<a.surfaces.length;r++){const l=a.surfaces[r];if(de(l))for(let c=0;c<s.length;c++){const f=s[c];l.y<=f.y&&f.y+f.height<l.y+l.height&&l.x<=f.x&&f.x+f.width<=l.x+l.width&&(f.velocity=ft(f.velocity,{x:0,y:-.002*l.force*i}))}if(Oe(l)){const c=l,f=a.y,w=a.y-b;c.yDirection===-1&&c.y<=w?(c.yDirection=0,c.dockStartTime=e):c.y<=w&&e-c.dockStartTime>hi?c.yDirection=1:c.yDirection===1&&f<=c.y?(c.yDirection=0,c.dockStartTime=e):f<=c.y&&e-c.dockStartTime>hi&&(c.yDirection=-1);const p=c.yDirection*wn*i;c.y+=p;for(let d=0;d<s.length;d++){const m=s[d];fe(c,m)&&(m.y+=p)}}}}}get(e){return this.elements[e]}isFree(e,i){if(e<0||this.elements.length<=e)return!1;const s=this.elements[e];return s.surfaces.length===0?this.elements[Math.max(e-1,0)].isFree(i,s.y):s.isFree(i)}getBlock(e,i){return e<0||this.elements.length<=e?Fi(e,i,this.startY-e*b):this.elements[e].getBlock(i)}getBlockAt(e){const i=Math.floor(Math.max(this.startY-e.y,0)/b),s=Math.min(i,this.elements.length-1),n=Math.floor((e.x-v)/u);return this.getBlock(s,n)}getCheckpoint(e){return this.checkpoints[e].element}findLatestCheckpoint(e){for(let i=this.checkpoints.length-1;i>=0;i--){const s=this.checkpoints[i];if(e<s.y-s.element.height*.15)return i}return 0}getBetween(e,i){const s=Math.ceil(Math.max(this.startY-e,0)/b),n=Math.floor(Math.max(this.startY-i,0)/b);return{minI:Math.max(n-1,0),maxI:Math.min(s,this.elements.length)-1}}isOnPlatform(e,i){const{minI:s,maxI:n}=e;for(let a=n;a>=s;a--){const l=this.get(a).surfaces;for(let c=0;c<l.length;c++){const f=l[c];if(fe(i,f))return!0}}return!1}}const vn=70,ci=400,fi=5,di=40,Sn=3*Ri,gi=1e3;var Ye=(t=>(t[t.RUNNING=0]="RUNNING",t[t.GAME_OVER=1]="GAME_OVER",t[t.FINISHED=2]="FINISHED",t))(Ye||{});function In(t){for(let e=t.length-1;e>=0;e--){const i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}}class ui{constructor(e,i,s,n,a){y(this,"camera",new gs(this,g));y(this,"platePattern");y(this,"track");y(this,"characters",[]);y(this,"charactersCount",40);y(this,"player",new Fe(0,void 0,0,0));y(this,"x");y(this,"y");y(this,"width");y(this,"height");y(this,"state",0);this.platePattern=a,this.track=new bn(e,ci),this.x=0-this.track.width/2-fi,this.y=ci-this.track.height-di,this.width=this.track.width+2*fi,this.height=this.track.height+2*di;const r=this.track.get(0),l=15,c=r.width/l,f=Xe.height*1.9,w=c*.3;this.player=new Fe(0,this.track,i,s),this.characters.push(this.player);for(let d=1;d<(n?n.length:this.charactersCount);d++){if(n&&n[d].eliminated)continue;const m=new Fe(d,this.track);this.characters.push(m)}const p=[this.player,...this.characters];In(p);for(let d=0;d<p.length;d++){const m=p[d],S=Math.floor(d/l),I=d%l,R={x:r.minX+w+I*c,y:r.y+S*f};m.x=R.x,m.y=R.y}this.camera.follow(this.player),this.camera.visibleAreaHeight=vn,this.camera.yAdjust=-.25,this.camera.update(0)}update(e,i){this.camera.update(e),this.track.update(e,i,this.characters),this.calculateMovement(e,i),this.checkCollisions();for(let s=0;s<this.characters.length;s++)this.characters[s].move();this.updateCharacterRanks(),this.checkGameState()}playWithVolumeByDistance(e,i){const s=Math.abs(i-this.player.y);st(e,Math.max(0,Math.min(1,1-s/Sn)))}calculateMovement(e,i){for(let s=0;s<this.characters.length;s++){const n=this.characters[s],a=this.track.getBetween(n.y,n.y+n.height);let r=J;n.fallStartTime!=null?e-n.fallStartTime>ue+gi&&this.dropToLatestCheckpoint(e,n):n.fallStartTime==null&&!this.track.isOnPlatform(a,n)?(n.fallStartTime=e,n===this.player&&setTimeout(()=>{const l=this.track.getCheckpoint(this.player.latestCheckpointIndex),c=l.y+l.height/2;this.camera.setTransition({startY:this.player.y,endY:c,startTime:e,duration:gi+500})},ue)):(r=n.getMovement(e),n.setDirection(r),n.velocity=Ss(n,r,i))}}checkCollisions(){for(let e=0;e<this.characters.length;e++){const i=this.characters[e];if(!i.doesNotCollide)for(let s=e+1;s<this.characters.length;s++){const n=this.characters[s];n.doesNotCollide||ks(i,n)&&(!i.ai||Xt(i.velocity)>.3)&&this.playWithVolumeByDistance(_i,i.y)}}for(let e=0;e<this.characters.length;e++){const i=this.characters[e],s=this.track.getBetween(i.y,i.y+i.height),{minI:n,maxI:a}=s;for(let r=n;r<=a;r++){const l=this.track.get(r);for(let c=0;c<l.objects.length;c++){const f=l.objects[c];Is(i,f)&&this.playWithVolumeByDistance(Wi,f.y)}}}}renderText(e,i,s,n){const a=o.measureText(e),r=i+(n-a.width)/2;o.fillText(e,r,s)}updateCharacterRanks(){const e=this.characters.filter(n=>n.finished),i=this.characters.filter(n=>!n.finished);e.sort((n,a)=>n.rank-a.rank),i.sort((n,a)=>n.y+n.height/2-(a.y+a.height/2)),[...e,...i].forEach((n,a)=>{n.rank=a+1})}checkGameState(){for(let e=0;e<this.characters.length;e++){const i=this.characters[e],s=this.track.findLatestCheckpoint(i.y),n=this.track.getBetween(i.y,i.y+i.height);if(!(i.fallStartTime!=null||!this.track.isOnPlatform(n,i))){if(s>i.latestCheckpointIndex&&(i.latestCheckpointIndex=s,i.rank===13)){i.eliminated=!0,i.stop(),i.ai||(this.state=1);continue}if(i.y+i.height<this.track.finishY&&(i.rank===13?(i.eliminated=!0,i.stop(),i.ai||(this.state=1)):(i.finished=!0,i.stop()),!i.ai||i.rank==this.characters.length-13)){let a=this.characters.filter(r=>r.eliminated).length;for(let r=0;r<this.characters.length;r++)if(this.characters[r].rank>this.characters.length-13)if(a<13)this.characters[r].eliminated||(this.characters[r].eliminated=!0,a++);else break;this.characters[0].eliminated?this.state=1:this.state=2}}}}dropToLatestCheckpoint(e,i){const s=this.track.getCheckpoint(i.latestCheckpointIndex),n={x:xs(s.minX+u,s.maxX-u),y:s.y+s.height/2,width:i.width,height:i.height};if(!this.characters.some(a=>fe(a,n))){if(i.rank===13){i.eliminated=!0,i.stop(),i.ai||(this.state=1);return}i.drop(e,n),this.playWithVolumeByDistance(Li,i.y),i===this.player&&this.camera.follow(i)}}drawCross(e,i,s,n="red"){o.strokeStyle=n,o.lineWidth=s/4,o.beginPath(),o.moveTo(e-s/2,i-s/2),o.lineTo(e+s/2,i+s/2),o.moveTo(e+s/2,i-s/2),o.lineTo(e-s/2,i+s/2),o.stroke()}draw(e,i){o.save(),o.translate(g.width/2,g.height/2),o.scale(this.camera.zoom,this.camera.zoom),o.translate(-this.camera.x,-this.camera.y);const s=[...this.characters];this.drawTrack(s),this.drawObjects(e,i,s),o.restore(),this.drawGradient(),this.state===0&&(o.save(),o.translate(g.width/2,g.height/2),o.scale(this.camera.zoom,this.camera.zoom),o.translate(-this.camera.x,-this.camera.y),this.drawStatusOfCharacters(e),this.drawTopStatusTexts(),o.restore())}drawTrack(e){o.save();const i=this.camera.getViewArea(),{minI:s,maxI:n}=this.track.getBetween(i.y,i.y+i.height);for(let a=n;a>=s;a--){const r=this.track.get(a),l=r.surfaces;o.fillStyle=r.color,o.shadowColor=r.color.replace("rgb(","rgba(").replace(")",",0.3)"),o.shadowOffsetY=r.height*(r.type===ht.Raft?2:6),r.type===ht.Raft&&(o.globalAlpha=.5);for(let c=0;c<l.length;c++){const f=l[c];this.drawSurface(r,f)}o.globalAlpha=1,e.push(...r.objects)}o.restore()}drawSurface(e,i){if(o.strokeStyle="rgba(255,255,255,0.4)",o.lineWidth=.1,e.type!==ht.Raft&&o.strokeRect(i.x,i.y+.1,i.width,i.height),o.save(),de(i)){const s=i.force;o.fillStyle=`rgba(${220+s*50}, ${80+s*50}, ${60+s*50}, ${1-s})`}if(o.fillRect(i.x,i.y,i.width,i.height),o.restore(),e.type===ht.Raft)o.strokeRect(i.x,i.y,i.width,i.height);else if(de(i)){o.shadowOffsetY=0,o.font="9px Arial",o.textAlign="center",o.textBaseline="middle",o.fillStyle="rgba(255, 255, 255, 0.1)";const s=e.width/(e.width/10);for(let n=1;n<=i.width/9-1;n++)o.fillText("⇪",i.x+n*s,i.y+i.height/2)}else if(e.type===ht.CheckPoint||e.type===ht.Finish){o.fillStyle="rgba(255, 255, 255, 0.2)",o.fillRect(i.x,i.y+i.height-4,i.width,4),o.shadowOffsetY=0,o.font="9px Arial",o.textAlign="center",o.textBaseline="middle",o.fillStyle="rgba(255, 255, 255, 0.1)";const s=e.width/10;for(let n=1;n<=i.width/9-1;n++)o.fillText(e.type===ht.Finish?"✪":"✓",i.x+n*s,i.y+i.height/2.4)}this.platePattern&&(o.fillStyle=this.platePattern,o.fillRect(i.x,i.y,i.width,i.height),o.fillStyle=e.color)}drawObjects(e,i,s){s.sort((n,a)=>n.y+n.height/2-(a.y+a.height/2));for(let n=0;n<s.length;n++)s[n].draw(e,i)}drawGradient(){const e=o.createRadialGradient(g.width/2,g.height/2,0,g.width/2,g.height/2,g.width/1.5);e.addColorStop(1,"rgba(0, 0, 0, 0)"),e.addColorStop(.8,"rgba(0, 0, 0, 0)"),e.addColorStop(0,"rgba(255, 255, 255, 0.3)"),o.fillStyle=e,o.fillRect(0,0,g.width,g.height);const i=o.createLinearGradient(0,0,0,g.height);i.addColorStop(0,"rgba(0, 0, 0, 1)"),i.addColorStop(.2,"rgba(0, 0, 0, 0.5)"),i.addColorStop(1,"rgba(0, 0, 0, 0)"),o.fillStyle=i,o.fillRect(0,0,g.width,g.height)}drawStatusOfCharacters(e){this.characters.forEach(i=>{if(i.isVisible(e)){const s=`${i.rank}`;o.fillStyle=i.rank===13?"red":i.eliminated?"crimson":i.rank>this.characters.length-13?"orange":i.rank===1?"lightgreen":i.ai?"white":"yellow",o.font=i.ai?i.eliminated||i.rank===13?"1.2px Sans-serif":"1px Sans-serif":"1.4px Sans-serif",i.ai||(o.save(),o.font="4.0px Sans-serif",this.renderText("▲",i.x,i.y-i.height*3.25,i.width),o.restore()),i.eliminated&&this.drawCross(i.x-.25,i.y-i.height*2.7,1),this.renderText(i.eliminated?"13":s,i.x,i.y-i.height*2.5,i.width)}})}drawTopStatusTexts(){const e=this.characters.filter(s=>s.eliminated).length.toString(),i=this.characters.filter(s=>s.finished).length.toString();o.font="4px Impact",o.fillStyle=this.player.rank===13?"red":this.player.eliminated?"crimson":this.player.rank>this.characters.length-13?"orange":this.player.rank===1?"lightgreen":"yellow",o.fillText("▲ "+this.player.rank+" / "+this.characters.length,-42,this.camera.y-30),o.fillStyle="green",o.fillText("✪ "+i+" / "+(this.characters.length-13)+" QUALIFIED",-15,this.camera.y-30),o.fillStyle="red",this.drawCross(28,this.camera.y-31.5,3),o.fillText(e+" / 13",32,this.camera.y-30)}}const yi=[h.FullWidthWithObstacles,h.FullWidth,h.FullWidth,h.FullWidth],mi=[h.Basic,h.SlopeEmptyPassage,h.SlopeEmptyPassage,h.DualPassage,h.Basic,h.RightPassage,h.RightPassage,h.Basic,h.Basic,h.Raft,h.Chasm,h.FullWidth],kn=[h.BasicSteepSlope,h.BasicSlope,h.FullWidthWithObstacles,h.FullWidthWithMoreObstacles,h.FullWidthWithObstacles,h.DualPassage,h.DualPassage,h.DualPassage,h.FullWidth];function xn(){const t=wt(1);return[h.Checkpoint,...t<.5?yi:mi,h.Checkpoint,...t<.5?mi:yi,h.Checkpoint,...kn,h.Finish]}const pi=[h.FullWidth,h.BasicSteepSlope,h.BasicSlope,h.BasicSlope,h.Basic,h.Basic,h.Basic,h.Narrow,h.VeryNarrow,h.VeryNarrow,h.Basic,h.FullWidthWithObstacles,h.SlopeObstacleSlope,h.PassageEmptySlope,h.PassageEmptySlope,h.DualPassage,h.DualPassage,h.FullWidth,h.FullWidthWithObstaclesOnRight,h.FullWidthWithObstaclesOnRight2,h.FullWidthWithObstaclesOnRight,h.FullWidth,h.Raft,h.Chasm],wi=[h.FullWidth,h.VeryNarrow,h.FullWidth,h.BasicSteepSlope,h.BasicSlope,h.BasicSlope,h.Basic,h.Basic,h.Basic,h.Basic,h.TwoRafts,h.Chasm];function Cn(){const t=wt(1);return[h.Checkpoint,...t<.5?pi:wi,h.Checkpoint,...t<.5?wi:pi,h.Finish]}const bi=[h.FullWidth,h.Basic,h.Narrow,h.VeryNarrow,h.Basic,h.SlopeEmptySlope,h.SlopeEmptySlope,h.SlopeEmptySlope,h.DualPassage,h.DualPassage,h.Basic,h.FullWidthWithObstacles,h.VeryNarrow,h.Basic],vi=[h.FullWidth,h.SlopeEmptySlope,h.PassageEmptySlope,h.PassageEmptySlope,h.DualPassage,h.SlopeEmptyPassage,h.DualPassageExt,h.TriplePassage,h.TriplePassage,h.TriplePassage,h.FullWidth],Si=[h.FullWidthWithObstacles,h.FullWidthWithMoreObstacles,h.FullWidth,h.TwoRafts,h.Chasm,h.Basic,h.FullWidth],Ii=[h.BasicSteepSlope,h.BasicSlope,h.BasicSlope,h.Basic,h.Basic,h.Basic,h.DualPassage,h.DualPassageExt,h.TriplePassage,h.TriplePassage,h.DualPassageExt,h.PassageEmptySlope,h.PassageEmptySlope,h.Basic,h.Basic,h.Narrow,h.VeryNarrow,h.FullWidth,h.RightPassage,h.FullWidth,h.TwoRafts,h.Chasm];function An(){const t=wt(1);return[h.Checkpoint,...t<.5?bi:vi,h.Checkpoint,...t<.5?vi:bi,h.Checkpoint,...t<.5?Si:Ii,h.Checkpoint,...t<.5?Ii:Si,h.Finish]}const En="2025-05-04",Mn="Director's cut ("+En+")",$e=1e3/60,Pn=$e*5;let ze=performance.now(),xt=0,At=1+Math.random()*.6,Et=1+Math.random()*.3,le=1,P,$=0,we=0,Ui=0;const Rn=5e3;let E=0,Vi=0;const ye=ss(),ki=ns();let kt=0;const U=document.createElement("button"),V=document.createElement("button"),X=document.createElement("button"),me="startButton",it=async t=>{we=t;const e=document.getElementById("restartButton");e&&(e.style.display=t!==1?"block":"none");const i=document.getElementById("fullscreenButton");switch(i&&(i.style.display=t!==1||!bt?"block":"none"),$=1280*2,t){case 2:await qe(0),await Ot(),it(3);break;case 3:await Ot(),it(4);break;case 4:it(5);break;case 5:if(kt=0,oi(),xt>1&&P&&!P.player.eliminated){const s=xt===3?An():Cn();P=new ui(s,At,Et,P.characters,ki)}else P=new ui(xn(),At,Et,void 0,ki);E=$,Vi=Ui,st(Di);break;case 7:E=1,st(Bi),At=1+Math.random()*.6,Et=1+Math.random()*.3,await Ot(),xt=1,st(ge),it(2);break;case 8:E=1,st(Hi),P&&P.characters.length>14?(await qe(2500),await Ot(),xt++,it(5)):(await Ot(),xt=1,$s(),st(ge),it(2));break;case 6:$i();break;case 1:oi();break}},Ki=t=>{requestAnimationFrame(Ki);const e=t-ze;if(e>=$e){const i=Math.min(e,Pn);ze=t-e%$e,Fn(t,i),On(t,i)}},Fn=(t,e)=>{switch(we){case 6:{un(),P==null||P.update(t,e),(P==null?void 0:P.state)===Ye.GAME_OVER?it(7):(P==null?void 0:P.state)===Ye.FINISHED&&it(8);break}case 5:{kt===2&&E<$/4?(st(Ni),kt++):(kt===1&&E<$/2||kt===0&&E<$)&&(st(_e),kt++);break}}};let ce=0;const xi="LOADING...",Tn=()=>{const t=ce<10?xi.substring(0,ce):"LOADING...";H(t+(ce++%60===0?"":"█"),_.Small,"Courier New",1,7.7,!0,0,xi)},On=(t,e)=>{switch(Ui=t,o.save(),o.fillStyle="rgb(0, 0, 20)",o.fillRect(0,0,g.width,g.height),P==null||P.draw(t,e),o.restore(),o.save(),we){case 0:{Tn(),ce++,Ei(),lt(!1);break}case 1:{if(Dn(!0),bt){const i=document.getElementById(me);i&&i.style.display==="none"&&(i.style.display="block")}else Zt("start");break}case 2:{Te(t++,!1,0),It(),lt(!0);break}case 3:{Te(t++,!0,le=le+.01),It(),lt(!0);break}case 4:{Te(t++,!0,le=le+.01);const i=g.width/2,s=g.height/2;o.beginPath(),o.arc(i,s,E,0,Math.PI*2),o.fillStyle="#802010",o.fill(),E<$&&(E+=e),It(),lt(!0);break}case 5:{const i=g.width/2,s=g.height/2;E<=0?it(6):(E>0&&(o.beginPath(),o.arc(i,s,E,0,Math.PI*2),o.fillStyle=E<$/4?"#105000":E<$/2?"#CCCC40":"#802010",o.fill()),E<$/4?H("▲ GO! ▲",_.Xl,"Impact",E/$*4):E<$/2?H("Set...",_.Xl,"Impact",1):H("Ready...",_.Xl,"Impact",1),E>0&&(E=(1-(t-Vi)/Rn)*$)),It(),lt(!0);break}case 7:{const i=g.width/2,s=g.height/2;o.beginPath(),o.arc(i,s,E,0,Math.PI*2),o.fillStyle="#802010",o.fill(),H("❌ ELIMINATED!",_.Large,"Impact",1,-4.5),(P==null?void 0:P.player.rank)===13?H("Don't be the 13TH GUY",_.Small,"Sans-serif"):(H("Don't be one of the last 13TH GUYs",_.Small,"Sans-serif"),H("The final rank is "+(P==null?void 0:P.player.rank)+".",_.Normal,"Impact",1,3.1)),E>=$&&Zt("continue",9),E<$&&(o.save(),o.globalAlpha=.7,o.translate(g.width/8,E*2-g.height),te(o,"eliminated",g.height/6*At,g.height/2*Et,t,q.Backward,gt.Fall,ye),o.globalAlpha=0,o.restore()),E<$&&(E+=e),It(),lt(!0);break}case 8:{const i=g.width/2,s=g.height/2;o.beginPath(),o.arc(i,s,E,0,Math.PI*2),o.fillStyle="#105000",o.fill(),E>=$/4&&(P&&P.characters.length>14?(H("✪ QUALIFIED!",_.Large,"Impact",1,-5),H("☻",_.Huge,"Impact"),H("Ready for next round "+(xt+1)+" / 3",_.Normal,"Sans-serif",1,3.8)):(H("GAME FINISHED!",_.Large,"Impact",1,-5),H("☻",_.Huge,"Impact"),H("Congratulations to the winner!",_.Normal,"Impact",1,3.8)),E>=$&&Zt(),o.save(),o.translate(E<g.width/6?E:g.width/6,g.height/3),te(o,Ue,g.height/6*At,g.height/2*Et,t,E<g.width/6?q.Right:P&&P.characters.length<=14||t%3600>1800?q.Backward:q.BackwardRight,P&&P.characters.length>14?gt.Walk:gt.Celebrate,ye),o.restore()),E<$&&(E+=e),It(),lt(!0);break}default:{const i=document.getElementById(me);i&&i.style.display!=="none"&&(i.style.display="none"),lt(!1),$i();break}}o.restore()},qi=()=>{H(Mn,_.Tiny,"Impact",.5,2.3,!1),H("Don't be the",_.Small,"Impact",1,-1.8,!0,-.9),H("❌ 13TH GUY",_.Xl,"Impact",1,1.8)},Te=(t,e,i)=>{o.save(),o.fillStyle="rgb(20, 20, 50)",o.rect(0,0,g.width,g.height),o.fill(),o.save(),o.translate(g.width/8+i,g.height/3),te(o,Ue,(e?g.height/6/i:g.height/6)*At,(e?g.height/2/i:g.height/2)*Et,t,e?q.Forward:t%3600<1800?q.BackwardRight:q.Backward,gt.Walk,ye,e),o.restore(),e?(H("Avoid being the 13th or among the last 13",_.Small,"Sans-serif",1,-1.2),H("or you will be eventually ❌ eliminated!",_.Small,"Sans-serif",1,1.3),H("MOVE WITH",_.Xs,"Sans-serif",.8,-7.5),H("▲ / W - ▼ / S - ◄ / A - ► / D",_.Xs,"Sans-serif",.8,-5.6),we===3&&Zt("start the race!")):(qi(),Zt()),o.restore()},Dn=t=>{o.save(),o.fillStyle="rgb(20, 20, 50)",o.rect(0,0,g.width,g.height),o.fill(),o.save(),o.translate(g.width/8,g.height/3),te(o,Ue,g.height/6*At,g.height/2*Et,0,q.Backward,gt.Stand,ye),o.restore(),qi(),o.filter="",Ei(),It(),lt(t)};async function Ci(){console.log("postInitActions: Starting...");const t=document.getElementById(me);t&&(t.style.display="none"),st(De),xt=1,await it(2),console.log("postInitActions: Finished.")}async function Ai(){const t=document.documentElement,e=document.getElementById("fullscreenButton");if(document.fullscreenElement)try{await document.exitFullscreen(),e&&(e.textContent="⛶")}catch(i){if(i instanceof Error){console.error(`Error exiting fullscreen:${i.message} (${i.name})`);return}}else{try{t.requestFullscreen?await t.requestFullscreen():t.webkitRequestFullscreen?await t.webkitRequestFullscreen():t.mozRequestFullScreen&&await t.mozRequestFullScreen()}catch(i){if(i instanceof Error){console.error(`Error attempting to enable full-screen mode: ${i.message} (${i.name})`);return}}e&&(e.textContent="╬")}}const Wn=async()=>{g.tabIndex=0,g.style.outline="none",yn(),ze=performance.now(),window.requestAnimationFrame(Ki);const t="10px",e="10",i="40px",s="rgba(255, 255, 255, 0.4)",n="black",a="1px solid rgba(255, 255, 255, 0.2)",r="4px",l="24px",c="0";U.id="fullscreenButton",U.style.position="absolute",U.style.top=t,U.style.right="10px",U.style.zIndex=e,U.textContent="⛶",X.style.fontFamily="Impact",U.style.width=i,U.style.height=i,U.style.color=s,U.style.background=n,U.style.border=a,U.style.borderRadius=r,U.style.fontSize=l,U.style.lineHeight=c,U.style.display=bt?"none":"block",V.id="restartButton",V.style.position="absolute",V.style.top=t,V.style.right="60px",V.style.zIndex=e,V.textContent="↺",X.style.fontFamily="Impact",V.style.width=i,V.style.height=i,V.style.color=s,V.style.background=n,V.style.border=a,V.style.borderRadius=r,V.style.fontSize=l,V.style.lineHeight=c,V.style.display="none",X.id=me,X.style.position="absolute",X.textContent="Tap the screen to continue█",X.style.padding="20vw 0 0 0",X.style.fontFamily="Courier New",X.style.background="transparent",X.style.border="none",X.style.fontSize="2vw",X.style.top="0",X.style.bottom="0",X.style.left="0",X.style.right="0",X.style.zIndex=e,X.style.color=s,X.style.display="none",document.body.appendChild(V),document.body.appendChild(U),document.body.appendChild(X),U.addEventListener("click",async f=>{f.stopPropagation();const w=f.currentTarget;await ae();try{await Ai()}finally{w.blur()}}),V.addEventListener("click",async f=>{f.stopPropagation();const w=f.currentTarget;await ae(),w.blur(),window.location.reload()}),await ln(),await it(1),bt?(X.addEventListener("click",async f=>{console.log("Start button clicked (touch)."),f.stopPropagation();const w=f.currentTarget;await ae();try{Ai().catch(p=>console.error("Initial fullscreen failed:",p))}finally{w.blur(),await Ci()}},{passive:!1,once:!0}),console.log("Touch interaction listener added.")):(await Ot(),await ae(),await Ci()),console.log("init function finished.")},ji=1280,Qi=720;window.addEventListener("resize",()=>Gi(ji,Qi),!1);Gi(ji,Qi);Wn();
